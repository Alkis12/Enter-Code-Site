
# Enter Code Site Backend

Бэкенд образовательной платформы на FastAPI, MongoDB и Beanie ODM.

## Структура и логика

### Модели:
- **User**: пользователь (студент, преподаватель, админ), содержит имя, фамилию, tg_username, роль, статус, телефон, аватар, биографию, токены, хэш пароля.
- **Course**: курс, содержит название, описание, список преподавателей, учеников, тем.
- **Topic**: тема курса, содержит название, номер, список задач.
- **Task**: задача, содержит условие, историю чата, результаты (статус, оценка, пользователь).

### Основные бизнес-процессы:
- Регистрация и аутентификация пользователей (JWT, refresh/access токены).
- Управление курсами: создание, просмотр, добавление/удаление студентов и преподавателей.
- Управление темами и задачами: добавление, редактирование, удаление, перемещение.
- Обновление профиля, смена и восстановление пароля, удаление аккаунта.
- Проверка прав доступа по ролям.

### Эндпоинты:

#### /auth
- `POST /auth/register` — регистрация пользователя
- `POST /auth/login` — вход пользователя
- `POST /auth/me` — информация о пользователе по токену
- `POST /auth/refresh` — обновление access_token по refresh_token
- `POST /auth/change_password` — смена пароля
- `POST /auth/update_user` — обновление профиля
- `POST /auth/logout` — выход (инвалидация токенов)
- `POST /auth/verify_email` — подтверждение email (отправка/проверка кода)
- `POST /auth/reset_password` — восстановление пароля (отправка ссылки/кода)
- `GET /auth/history` — история входов
- `DELETE /auth/delete_account` — удаление аккаунта

#### /users
- `GET /users/` — список всех пользователей
- `GET /users/profile` — профиль пользователя по id
- `GET /users/search` — поиск пользователей по имени

#### /course
- `POST /course/add` — создать курс
- `POST /course/add_student` — добавить ученика
- `POST /course/add_teacher` — добавить преподавателя
- `POST /course/remove_student` — удалить ученика
- `POST /course/remove_teacher` — удалить преподавателя
- `POST /course/info` — информация о курсе
- `POST /course/tree` — дерево курса (темы и задачи)
- `POST /course/result` — процент решённых задач по курсу для ученика
- `GET /course/list` — список всех курсов
- `GET /course/{id}` — детали курса
- `POST /course/{id}/enroll` — записаться на курс

#### /topic
- `POST /topic/add` — добавить тему в курс
- `POST /topic/delete` — удалить тему
- `POST /topic/info` — информация о теме
- `POST /topic/result` — процент решённых задач по теме для ученика
- `GET /topic/list` — список тем

#### /task
- `POST /task/add` — добавить задачу в тему
- `POST /task/update` — изменить задачу
- `POST /task/move` — переместить задачу
- `POST /task/delete` — удалить задачу
- `POST /task/info` — информация о задаче и статус ученика
- `GET /task/list` — список задач
- `GET /task/{id}` — детали задачи

### Авторизация и права
- Все защищённые эндпоинты требуют access_token.
- Проверка ролей реализована через функцию `get_current_user_with_role`.

### Логика работы:
- При регистрации создаётся пользователь, генерируются токены.
- При входе — проверка пароля, выдача токенов.
- При обновлении профиля/пароля — валидация, обновление данных.
- При работе с курсами/темами/задачами — проверка прав, изменение соответствующих коллекций.

### Быстрый старт
1. Установите зависимости:
   ```bash
   pip install poetry
   poetry install
   ```
2. Запустите MongoDB на localhost:27017.
3. Запуск приложения:
   ```bash
   poetry run uvicorn main:app --reload
   ```

### Зависимости
- fastapi
- uvicorn
- beanie
- motor
- pydantic
- python-jose
- passlib